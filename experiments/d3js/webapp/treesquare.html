<!DOCTYPE html>
<meta charset="utf-8">
<style>

.node circle {
  fill: #fff;
  stroke: steelblue;
  stroke-width: 1.5px;
}
.node rect {
  fill: #fff;
  stroke: steelblue;
  stroke-width: 1.5px;
}
.container rect {
  fill: none;
  stroke: steelblue;
  stroke-width: 1.5px;
}
.node {
  font: 10px sans-serif;
}

.link {
  fill: none;
  stroke: #ccc;
  stroke-width: 1.5px;
}

</style>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>

var width = 480,
    height = 600;
 var force = d3.layout.force()
        .size([width, height]);
    /*
    d3.layout.force()
            .gravity(0.1)
            .charge(-30)
            .friction(0.95)
            .linkDistance(20)
            .linkStrength(1);//*/
var tree = d3.layout.tree()
    .size([height, width - 160]);

var diagonal = d3.svg.diagonal()
    .projection(function(d) { return [d.y-20, d.x]; });

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height)
  .append("g")
    .attr("transform", "translate(40,0)");
  
var root = {
 "name": "flare",
 "children": [
  {
   "name": "analytics",
   "children": [
    {
     "name": "cluster",
     "children": [
      {"name": "AgglomerativeCluster", "size": 3938},
      {"name": "CommunityStructure", "size": 3812},
      {"name": "MergeEdge", "size": 743}
     ]
    },
    {
     "name": "graph",
     "children": [
      {"name": "BetweennessCentrality", "size": 3534},
      {"name": "LinkDistance", "size": 5731}
     ]
    }
   ]
  }
 ]
};
  
 function init(root) {
   //creates nodes and links from input
  var nodes = tree.nodes(root),
      links = tree.links(nodes);

  var link = svg.selectAll(".link")
      .data(links)
    .enter().append("path")
      .attr("class", "link")
      .attr("d", diagonal);

  var selection = svg.selectAll(".node");
  var data = selection.data(nodes);

  var node = //svg.selectAll(".node").data(nodes)
    data
    .enter().append("g")
      .attr("class", "node")
      .attr("transform", function(d) { return "translate(" + (d.y-20) + "," + (d.x-16) + ")"; });

   //x0,y=0 before translation      
  node.append("rect")
        .attr("rx","4")
        .attr("ry","4")
          .attr("height", 32)
          .attr("width", 20);

  node.append("text")
      .attr("dx", function(d) { return d.children ? -20 : 20; })
      .attr("dy", -20)
      .style("text-anchor", function(d) { return d.children ? "end" : "start"; })
      .text(function(d) { return d.name; });
   

   //bounding boxes
     var container = svg.selectAll(".container")
      .data(nodes.filter(function(d, i) { 
        return (typeof d.children != "undefined" && d.children.length>1)?d:null; 
   }))

    .enter().append("g")
      .attr("class", "container")
     
      .attr("transform", function(d) { 
        //find min max d.x
        var minx = Number.MAX_VALUE;
        var maxx = Number.MIN_VALUE;
        for(var i in d.children){
           minx = Math.min(minx,d.children[i].x-30);
           maxx = Math.max(maxx,d.children[i].x+30);
        }

        console.log("min="+minx+" max="+maxx);
        d.minx = minx;
        d.maxx = maxx;
        var h = height/(Math.pow(2,d.depth));
        var w = width/(Math.pow(2,d.depth));
        return "translate(" + (d.children[0].y-40) + "," + (minx) + ")"; 
      });

   //x0,y=0 before translation      
       container.append("rect")
      
      .attr("height", function(d) { 
            var off = height/(Math.pow(2,d.depth-1));
        return d.maxx-d.minx; 
      })
      .attr("width", function(d) { 
        var off = width/(Math.pow(2,d.depth-1));
            //return off-40; 
            return 60;
     });//*/
}

init(root);
  
d3.select(self.frameElement).style("height", height + "px");

</script>